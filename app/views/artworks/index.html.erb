<div class="my_header">
    <li><%= link_to content_tag(:i, nil, class: 'fas fa-bars'), root_path %>
    </li>
    <div class="header_title">
      <div class="header_title_logo"></div>
    </div>
    <li>
    </li>
</div>



<div class="background-new-form">
</div>



<div class="body-container">
  <% if user_signed_in? %>
  <div id="map_index"></div>

  <div class="popup-container" style="display: none">
  </div>

  <%= render 'layouts/bottom_menu' %>

<!-- if user is not signed_in, he can sign in -->
  <% else %>

  <div class="connection">
    <!-- formulaire pour se connecter -->
    <div class="box-connection-top">
      <%= render "layouts/login" %>
      <br><br>
      <%= link_to "Mot de passe oublié ?", new_user_password_path %><br/>
    </div>
    <div class="box-connection-bottom">
          <%= link_to "Créer un compte", new_user_registration_path%>
    </div>
  </div>
  <% end %>
</div>


<div class="form-container">
  <div class="popup-form" style="display: none">
  </div>
</div>


<script type="text/javascript">

map = L.map('map_index').setView([ 48.866667,  2.333333], 13)

// This is a public token
L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoianVzdGlrcm8iLCJhIjoiY2plbzR6djJnM3RyOTJ4cGszb3hiNGdtcCJ9._gRBjH1x_-nGrj7hD-2i6g', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 20,
    id: 'mapbox.streets',
    accessToken: 'pk.eyJ1IjoianVzdGlrcm8iLCJhIjoiY2plbzR6djJnM3RyOTJ4cGszb3hiNGdtcCJ9._gRBjH1x_-nGrj7hD-2i6g'
}).addTo(map);

// Activate geoloc
L.control.locate().addTo(map)

// Puts markers on map
var markers_clusters = L.markerClusterGroup({
  disableClusteringAtZoom: 17
});

map.addLayer(markers_clusters);
var arr = <%= @artworks_js.html_safe %>
var markers = {};

// For each marker clicked, we send an AJAX request to show a small version of show artwork
 arr.forEach(function (markerConfig, index) {
  marker = new L.Marker([arr[index].lat,arr[index].long]);
  markers_clusters.addLayer(marker);
  
  marker.on('click', function(){
    $.ajax({
          type: "GET",
          contentType: "application/json; charset=utf-8",
          url: "artworks/show_small/"+arr[index].id,
      });
    });
  });

// If a user clicks on the map, the show_small of artworks is hidden
 map.on('click', function(){
  $(".popup-container").hide()
 });

getLocation();

console.log(sessionStorage.getItem('lat'));

function getLocation(){
  navigator.geolocation.watchPosition(locationFound, locationFailed, {
  enableHighAccuracy: false,
  timeout: 5000,
  maximumAge: 0
});  
}

function locationFound(position){
  sessionStorage.setItem("lat", position.coords.latitude);
  sessionStorage.setItem("lng", position.coords.longitude);
  console.log(sessionStorage.getItem('lat')+ ", " + sessionStorage.getItem('lng'));
}

function locationFailed(position){
  if (sessionStorage.getItem('lat') === null){
    alert("Merci d'activer votre géolocalisation !")
  }
}




</script>
